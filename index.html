<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CharityZap - Dira Diagnosis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-size: 16px;
    }
    .container {
      padding: 1rem;
    }
    #feed, #dira-diagnosis-results {
      max-height: 200px;
      overflow-y: auto;
      background: #fff;
      padding: 0.5rem;
      margin-top: 1rem;
      font-size: 14px;
    }
    .btn, .form-select {
      font-size: 16px;
      margin-bottom: 0.5rem;
    }
    .btn:active {
      opacity: 0.7;
    }
    @media (max-width: 576px) {
      h1 { font-size: 1.5rem; }
      .btn, .form-select { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CharityZap - Dira Diagnosis</h1>
    <button class="btn btn-primary" onclick="connectWallet()">Sign Pledge</button>
    <p id="wallet-status">Wallet: Not Connected</p>
    <p id="error-message" class="error"></p>
    
    <select id="cause-select" class="form-select mt-3">
      <option value="">Pick a Cause</option>
      <option value="Cleaning the Earth">Cleaning the Earth</option>
    </select>
    
    <h3 class="mt-4">Dira Diagnosis</h3>
    <button class="btn btn-warning" onclick="checkDIRADiagnosis()">Run Dira Diagnosis</button>
    <div id="dira-diagnosis-results" class="border p-3"></div>

    <h3 class="mt-4">Live Feed</h3>
    <div id="feed" class="border p-3"></div>
  </div>

  <script src="/js/solana-web3.js"></script> <!-- Local library -->
  <script src="/js/solana-spl-token.js"></script> <!-- Local library -->
  <script>
    // Initialize DOM elements
    const connectBtn = document.querySelector('.btn-primary');
    const walletStatus = document.getElementById('wallet-status');
    const causeSelect = document.getElementById('cause-select');
    const feed = document.getElementById('feed');
    const errorMessage = document.getElementById('error-message');
    const diraDiagnosisResults = document.getElementById('dira-diagnosis-results');

    let wallet = null;
    const connection = new Connection('https://api.mainnet-beta.solana.com', 'confirmed');
    const charityWallet = new PublicKey('2QJ9Bwy8NhVG6C62pQ8qVFuCr94oR17CBk4nk18Gkavp');
    const tokenMint = new PublicKey('53hZ5wdfphd8wUoh6rqrv5STvB58yBRaXuZFAWwitKm8');

    // Connect Wallet
    async function connectWallet() {
      errorMessage.textContent = '';
      try {
        if (window.solana && window.solana.isPhantom) {
          wallet = await window.solana.connect();
          walletStatus.textContent = `Wallet: ${wallet.publicKey.toString().slice(0, 8)}...`;
          console.log('Wallet connected:', wallet);
        } else {
          throw new Error('Phantom Wallet not detected');
        }
      } catch (err) {
        console.error('Wallet connection failed', err.stack || err);
        errorMessage.textContent = `Connection failed: ${err.message || 'Unknown error'}. Ensure Phantom is installed, unlocked, and allowed.`;
      }
    }

    // Dira Diagnosis Function (Near-Real-Time, Client-Side)
    async function checkDIRADiagnosis() {
      diraDiagnosisResults.innerHTML = '<p class="text-info">Analyzing DIRA status...</p>';
      try {
        // Hardcode DIRA token address for analysis
        const diraMint = new PublicKey('53hZ5wdfphd8wUoh6rqrv5STvB58yBRaXuZFAWwitKm8');

        // Open Solscan for DIRA in a new tab for manual verification
        const solscanUrl = `https://solscan.io/token/${diraMint.toString()}`;
        window.open(solscanUrl, '_blank');

        // Perform near-real-time client-side analysis using Solana RPC
        const tokenSupply = await getTokenSupply(diraMint);
        const holders = await getTokenHolders(diraMint); // Limited by front-end, placeholder
        const liquidityStatus = await checkLiquidity(diraMint);
        const recentVolume = await getRecentVolume(diraMint);

        // Generate a status, rating, and suggestions based on heuristics
        let diagnosis = `<p class="text-success">Dira Diagnosis Report for token: ${diraMint.toString()}</p>`;
        diagnosis += '<p>Current Status (as of ' + new Date().toLocaleString() + '):</p>';
        diagnosis += `
          <ul>
            <li><strong>Total Supply:</strong> ${tokenSupply / 1e4} DIRA (${formatNumber(tokenSupply)} smallest units, decimals = 4)</li>
            <li><strong>Number of Holders:</strong> ${holders.length || 'Unknown (verify on Solscan)'} (expected 57 per tokenomics)</li>
            <li><strong>Market Cap:</strong> ~$808.48 (verify on Solscan, price $0.0001652 per tokenomics)</li>
            <li><strong>Recent Transactions:</strong> ${recentVolume || 'Unknown (verify on Solscan)'} transfers in last 24 hours (expected ~749 total per tokenomics)</li>
            <li><strong>Liquidity Status:</strong> ${liquidityStatus} - Verify on Solscan or Raydium (${formatRaydiumPool()}) for locked status.</li>
          </ul>
        `;

        // Assign risk rating based on heuristics
        const rating = calculateRiskRating(tokenSupply, holders, liquidityStatus, recentVolume);
        diagnosis += `<p><strong>Risk Rating:</strong> ${rating}</p>`;

        // Provide suggestions for improvement
        const suggestions = generateSuggestions(rating, liquidityStatus, holders);
        diagnosis += '<p><strong>Suggestions for Improvement:</p></strong>' + suggestions;

        diagnosis += '<p>Instructions: Review Solscan data in the new tab for detailed transactions, holders, and market activity. Look for red flags like unlocked liquidity, active mint authority, or concentrated holdings (top 10 holders >30% of supply).</p>';

        diraDiagnosisResults.innerHTML = diagnosis;
      } catch (err) {
        console.error('Dira Diagnosis failed', err);
        diraDiagnosisResults.innerHTML = `<p class="text-danger">Error in Dira Diagnosis: ${err.message || 'Unknown error'}. Check console for details.</p>`;
      }
    }

    // Helper: Get token supply (using Solana RPC, near-real-time)
    async function getTokenSupply(mint) {
      try {
        const mintInfo = await connection.getMint(mint);
        return mintInfo.supply.toNumber(); // Returns smallest units (e.g., 4,894,683.13 * 10^4 for DIRA)
      } catch (err) {
        console.error('Failed to get token supply', err);
        return 0;
      }
    }

    // Helper: Get token holders (limited by front-end, placeholder for manual Solscan check)
    async function getTokenHolders(mint) {
      // Placeholder - real implementation requires a paid Solana RPC or Solscan API
      // Guide users to Solscan for manual verification
      console.log('Fetching holders manually via Solscan is required. Open https://solscan.io/token/', mint.toString(), 'and note the holders list (expected 57).');
      return []; // Return empty for client-side, as we can’t fetch without API
    }

    // Helper: Check liquidity (simplified, using Solscan/Raydium guidance)
    async function checkLiquidity(mint) {
      // Placeholder - real liquidity check requires Raydium API or Solscan data
      // Guide users to verify on Solscan or Raydium
      console.log('Verify liquidity on Solscan (https://solscan.io/token/', mint.toString(), ') or Raydium (https://app.meteora.ag/pools/9H67psNKre9dMAscpsYkEPGmYFw4MjeqV5Rmott2mDmd). Look for locked status.');
      return 'Unknown (manual verification required on Solscan or Raydium)';
    }

    // Helper: Get recent transaction volume (near-real-time, limited by RPC)
    async function getRecentVolume(mint) {
      try {
        // Query recent transactions for the token (simplified, limited by RPC rate limits)
        const recentTxs = await connection.getSignaturesForAddress(mint, { limit: 10 }); // Limited sample
        return recentTxs.length; // Approximate recent transfers (not exact, due to RPC limits)
      } catch (err) {
        console.error('Failed to get recent volume', err);
        return 'Unknown (verify on Solscan)';
      }
    }

    // Helper: Calculate risk rating (heuristic)
    function calculateRiskRating(supply, holders, liquidityStatus, recentVolume) {
      // Heuristic based on DIRA tokenomics and Solana rug check tools
      let risk = 'Low Risk';
      if (holders.length < 28 || holders.length === 0) { // Less than half of expected 57 holders
        risk = 'Moderate Risk (concentrated distribution)';
      }
      if (liquidityStatus.includes('Unknown') || liquidityStatus.includes('unlocked')) {
        risk = 'High Risk (liquidity unverified or unlocked)';
      }
      if (recentVolume === 'Unknown' || recentVolume < 1) {
        risk = 'Moderate Risk (low recent activity)';
      }
      return risk;
    }

    // Helper: Generate suggestions (heuristic)
    function generateSuggestions(rating, liquidityStatus, holders) {
      let suggestions = '<ul>';
      if (rating.includes('Moderate') || rating.includes('High')) {
        if (liquidityStatus.includes('Unknown') || liquidityStatus.includes('unlocked')) {
          suggestions += '<li>Lock DIRA liquidity on Raydium (https://app.meteora.ag/pools/9H67psNKre9dMAscpsYkEPGmYFw4MjeqV5Rmott2mDmd) to prevent rug pulls and ensure safe trading.</li>';
        }
        if (holders.length < 57 || holders.length === 0) {
          suggestions += '<li>Distribute DIRA more evenly to reduce concentration risk (e.g., target 57+ holders, ensure top 10 hold <30% of supply per Solana rug check standards).</li>';
        }
        suggestions += '<li>Verify and renounce mint/freeze authority on Solscan (https://solscan.io/token/53hZ5wdfphd8wUoh6rqrv5STvB58yBRaXuZFAWwitKm8) if controlled by 2QJ9Bwy8NhVG6C62pQ8qVFuCr94oR17CBk4nk18Gkavp or others, to build trust.</li>';
        suggestions += '<li>Monitor bot activity or high-frequency trading on DEXs (e.g., Raydium) to prevent manipulation, using Solscan’s transaction history.</li>';
      } else {
        suggestions += '<li>Continue monitoring DIRA’s status on Solscan and Raydium to maintain low risk. Ensure liquidity remains locked and distribution stays balanced.</li>';
      }
      suggestions += '</ul>';
      return suggestions;
    }

    // Helper: Format large numbers
    function formatNumber(num) {
      return num.toLocaleString();
    }

    // Helper: Format Raydium pool URL
    function formatRaydiumPool() {
      return 'https://app.meteora.ag/pools/9H67psNKre9dMAscpsYkEPGmYFw4MjeqV5Rmott2mDmd';
    }
  </script>
</body>
</html>
